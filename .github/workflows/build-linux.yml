name: Build Linux Binary and Release

on:
  push:
    branches: [master, main]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a new release'
        required: false
        default: true
        type: boolean


jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libauthen-ntlm-perl \
          libclass-load-perl \
          libcrypt-openssl-rsa-perl \
          libcrypt-ssleay-perl \
          libdata-uniqid-perl \
          libdigest-hmac-perl \
          libdist-checkconflicts-perl \
          libencode-imaputf7-perl \
          libfile-copy-recursive-perl \
          libfile-tail-perl \
          libio-compress-perl \
          libio-socket-inet6-perl \
          libio-socket-ssl-perl \
          libio-tee-perl \
          libjson-webtoken-perl \
          libmail-imapclient-perl \
          libmodule-scandeps-perl \
          libnet-dbus-perl \
          libnet-ssleay-perl \
          libpar-packer-perl \
          libproc-processtable-perl \
          libreadonly-perl \
          libregexp-common-perl \
          libsys-meminfo-perl \
          libterm-readkey-perl \
          libtest-fatal-perl \
          libtest-mock-guard-perl \
          libtest-mockobject-perl \
          libtest-pod-perl \
          libtest-requires-perl \
          libtest-simple-perl \
          libunicode-string-perl \
          liburi-perl \
          libtest-nowarnings-perl \
          libtest-deep-perl \
          libtest-warn-perl \
          make \
          time \
          cpanminus

    - name: Build binary
      run: |
        # Determine binary name
        KERNEL=$(uname -s)
        ARCH=$(uname -m)
        BIN_NAME="imapsync_bin_${KERNEL}_${ARCH}"
        echo "BIN_NAME=${BIN_NAME}" >> $GITHUB_ENV
        
        echo "Building ${BIN_NAME}..."
        
        # Run pp directly to avoid rcsdiff dependency in Makefile
        # -x: Execute the input file to find dependencies
        # -o: Output file
        pp -x -o "${BIN_NAME}" imapsync
        
        # Verify binary exists and is executable
        ls -l "${BIN_NAME}"
        chmod +x "${BIN_NAME}"
        
        # Basic execution test
        ./"${BIN_NAME}" --version
        ./"${BIN_NAME}" --justbanner

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.tag_name }}
        files: ${{ env.BIN_NAME }}
        generate_release_notes: true
